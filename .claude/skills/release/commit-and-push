#!/usr/bin/env python3
"""
Format, sync, commit, tag, and push released packages.

Usage:
  commit-and-push <package>:<version> [<package>:<version> ...]

Runs uv sync and ./scripts/fix first, then commits each package
with its changelog and lockfile changes, tags, and pushes.

The core "plain" package is always committed last if present.

Examples:
  commit-and-push plain-admin:0.65.1
  commit-and-push plain-admin:0.65.1 plain-dev:0.20.0 plain:0.103.0
"""

from __future__ import annotations

import subprocess
import sys
from pathlib import Path


def run(cmd: list[str], cwd: Path | None = None, check: bool = True) -> subprocess.CompletedProcess:
    print(f"  $ {' '.join(cmd)}")
    result = subprocess.run(cmd, cwd=cwd, capture_output=True, text=True)
    if check and result.returncode != 0:
        print(f"Error: {result.stderr.strip()}")
        sys.exit(1)
    if result.stdout.strip():
        for line in result.stdout.strip().split('\n'):
            print(f"    {line}")
    return result


def main():
    if len(sys.argv) < 2:
        print("Usage: commit-and-push <package>:<version> [<package>:<version> ...]")
        sys.exit(1)

    root = Path(__file__).resolve().parent.parent.parent.parent
    skill_dir = Path(__file__).resolve().parent

    releases: list[tuple[str, str]] = []
    for arg in sys.argv[1:]:
        if ':' not in arg:
            print(f"Error: Invalid format '{arg}', expected <package>:<version>")
            sys.exit(1)
        name, version = arg.split(':', 1)
        releases.append((name, version))

    # Sort: sub-packages first, core "plain" last
    releases.sort(key=lambda r: (r[0] == "plain", r[0]))

    # Phase: Format and sync
    print("Syncing and formatting...")
    run(["uv", "sync"], cwd=root)
    run(["./scripts/fix"], cwd=root)

    # Phase: Commit and tag each package
    for name, version in releases:
        print(f"\nCommitting {name} {version}...")

        if name == "plain":
            # Core package: add uv.lock directly (grep can't uniquely match "plain")
            run(["git", "add", "plain/pyproject.toml"], cwd=root)
            # Use glob to find CHANGELOG.md files
            import glob
            changelogs = glob.glob("plain/**/CHANGELOG.md", root_dir=root, recursive=True)
            for cl in changelogs:
                run(["git", "add", cl], cwd=root)
            run(["git", "add", "uv.lock"], cwd=root)
        else:
            run(["git", "add", f"{name}/pyproject.toml"], cwd=root)
            # Use glob to find CHANGELOG.md files
            import glob
            changelogs = glob.glob(f"{name}/**/CHANGELOG.md", root_dir=root, recursive=True)
            for cl in changelogs:
                run(["git", "add", cl], cwd=root)
            # Stage matching uv.lock hunks
            dot_name = name.replace("plain-", "plain.")
            run(
                [sys.executable, str(skill_dir / "add-hunks"), "uv.lock", "--grep", dot_name, "--context"],
                cwd=root,
            )

        run(
            ["git", "commit", "-m", f"Release {name} {version}", "-n"],
            cwd=root,
        )
        run(
            ["git", "tag", "-a", f"{name}@{version}", "-m", f"Release {name} {version}"],
            cwd=root,
        )
        print(f"  Tagged {name}@{version}")

    # Phase: Push
    print("\nPushing...")
    run(["git", "push", "--follow-tags"], cwd=root)
    print("\nDone!")


if __name__ == "__main__":
    main()
