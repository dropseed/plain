#!/usr/bin/env python3
"""
Validate type annotations for directories that should have 100% coverage.

This script ensures that once a directory reaches 100% type annotation coverage,
it stays at 100% to prevent backwards regressions.
"""

import sys
import subprocess
import json
from pathlib import Path

# Paths (files or directories) that must maintain 100% type annotation coverage
FULLY_TYPED_PATHS = [
    # Fully typed packages
    "plain",
    "plain-admin",
    "plain-api",
    "plain-auth",
    "plain-cache",
    "plain-code",
    "plain-dev",
    "plain-elements",
    "plain-email",
    "plain-esbuild",
    "plain-flags",
    "plain-htmx",
    "plain-loginlink",
    "plain-oauth",
    "plain-pages",
    "plain-pageviews",
    "plain-passwords",
    "plain-pytest",
    "plain-redirection",
    "plain-sessions",
    "plain-observer",
    "plain-support",
    "plain-toolbar",
    "plain-tunnel",
    "plain-vendor",
    "plain-worker",
    # plain-models: Fully typed directories
    "plain-models/plain/models/functions",
    # plain-models: Fully typed individual files
    "plain-models/plain/models/aggregates.py",
    "plain-models/plain/models/config.py",
    "plain-models/plain/models/connections.py",
    "plain-models/plain/models/constants.py",
    "plain-models/plain/models/database_url.py",
    "plain-models/plain/models/db.py",
    "plain-models/plain/models/enums.py",
    "plain-models/plain/models/exceptions.py",
    "plain-models/plain/models/indexes.py",
    "plain-models/plain/models/otel.py",
    "plain-models/plain/models/preflight.py",
    "plain-models/plain/models/registry.py",
    "plain-models/plain/models/transaction.py",
    "plain-models/plain/models/utils.py",
]


def check_type_coverage(path: str) -> tuple[float, int, int]:
    """Check type coverage for a file or directory."""
    result = subprocess.run(
        ["./scripts/type-coverage", path, "--json"],
        capture_output=True,
        text=True,
    )

    if result.returncode != 0:
        print(f"Error checking coverage for {path}:", file=sys.stderr)
        print(result.stderr, file=sys.stderr)
        return 0.0, 0, 0

    data = json.loads(result.stdout)
    return (
        data["overall_coverage"],
        data["fully_typed_functions"],
        data["total_functions"],
    )


def run_type_check(path: str) -> bool:
    """Run type checker on a file or directory."""
    result = subprocess.run(
        ["./scripts/type-check", path],
        capture_output=True,
        text=True,
    )

    if result.returncode != 0:
        print(f"Type check failed for {path}:", file=sys.stderr)
        print(result.stdout, file=sys.stderr)
        print(result.stderr, file=sys.stderr)
        return False

    return True


def main():
    """Main entry point."""
    print("Validating type annotations for fully typed paths...")
    print()

    failed_items = []

    for path in FULLY_TYPED_PATHS:
        path_obj = Path(path)
        if not path_obj.exists():
            print(f"⚠️  {path} does not exist, skipping")
            continue

        print(f"Checking {path}...")

        # Check coverage
        coverage, typed, total = check_type_coverage(path)

        if coverage < 100.0:
            print(f"  ✗ Coverage: {coverage:.1f}% ({typed}/{total}) - Expected 100%")
            failed_items.append((path, f"coverage {coverage:.1f}%"))
        else:
            print(f"  ✓ Coverage: 100% ({typed}/{total})")

        # Run type checker
        if not run_type_check(path):
            print(f"  ✗ Type check failed")
            failed_items.append((path, "type check failed"))
        else:
            print(f"  ✓ Type check passed")

        print()

    if failed_items:
        print("❌ Type validation failed for the following paths:")
        for path, reason in failed_items:
            print(f"  - {path}: {reason}")
        print()
        print("To fix:")
        print("  1. Check coverage: ./scripts/type-coverage <path> --details --missing")
        print("  2. Add missing annotations")
        print("  3. Run type check: ./scripts/type-check <path>")
        print("  4. Format: ./scripts/fix")
        sys.exit(1)

    print("✓ All paths passed type validation")
    sys.exit(0)


if __name__ == "__main__":
    main()
