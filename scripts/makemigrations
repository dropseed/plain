#!/bin/bash -e

# Makemigrations requires a database connection to check migration history consistency.
# Use PostgreSQL - same container as scripts/test if available.

cd example

if [ -z "$DATABASE_URL" ]; then
  export DATABASE_URL="postgres://postgres:postgres@localhost:5432/plain_example"

  # Start PostgreSQL via Docker if not already running
  if ! pg_isready -h localhost -p 5432 -U postgres >/dev/null 2>&1; then
    echo "Starting PostgreSQL via Docker..."
    docker run -d --name plain-postgres-dev \
      -e POSTGRES_PASSWORD=postgres \
      -e POSTGRES_DB=plain_example \
      -p 5432:5432 \
      postgres:16 >/dev/null 2>&1 || true

    for i in {1..30}; do
      pg_isready -h localhost -p 5432 -U postgres >/dev/null 2>&1 && break
      sleep 1
    done
  fi
fi

uv run plain makemigrations "$@"
