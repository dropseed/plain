#!/bin/sh -e

compile_readme() {
    package_readme="$1"
    code_readme="$2"

    echo "Compiling $code_readme to $package_readme"

    header_comment="<!-- This file is compiled from $code_readme. Do not edit this file directly. -->\n"

    # Copy plain/plain/README.md to plain/README.md and add a header comment
    echo "$header_comment" > "$package_readme"
    cat "$code_readme" >> "$package_readme"

    code_base_dir=$(dirname "$code_readme")

    # support ../ and other paths...
    docs_url="https://plainframework.com/docs"

    if [ "$(uname)" = "Darwin" ]; then
        SED_CMD=(sed -i '' -e)
    else
        SED_CMD=(sed -i -e)
    fi

    "${SED_CMD[@]}" "s#](\./\([^)]*\))#]($docs_url/$code_base_dir/\1)#g" "$package_readme"
}

compile_readme "plain/README.md" "plain/plain/README.md"

# Now do the same for every plain-* package and the README.md found at plain-<pkg>/plain/*/README.md
for package_dir in plain-*; do
    package_name=$(echo "$package_dir" | sed -e "s/^plain-//")
    package_readme="$package_dir/README.md"
    code_readme="$package_dir/plain/$package_name/README.md"
    compile_readme "$package_readme" "$code_readme"
done
