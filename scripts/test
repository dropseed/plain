#!/bin/bash -e

# Run the test-suite for each first-party package as well as the demo projects.
#
#  â€¢ Installs psycopg database driver wheel on-demand.

# ---------------------------------------------------------------------------
# CLI option parsing
# ---------------------------------------------------------------------------
# A single package name may be supplied to limit the run; otherwise test all
# first-party packages in a deterministic order.
ALL_PACKAGES="$(cat <<EOF
plain
plain-models
plain-sessions
plain-jobs
plain-flags
plain-admin
plain-oauth
plain-auth
plain-api
plain-elements
plain-htmx
EOF
)"

packages=$ALL_PACKAGES
if [ $# -gt 0 ] && printf '%s\n' $ALL_PACKAGES | grep -x "$1" >/dev/null; then
  packages=$1
  shift
fi

# Convenience for bold headings.
bold() { printf '\033[1m%s\033[0m\n' "$1"; }

# ---------------------------------------------------------------------------
# Database URL (PostgreSQL required)
# ---------------------------------------------------------------------------
if [ -z "$DATABASE_URL" ]; then
  echo "ERROR: DATABASE_URL is required. PostgreSQL is the only supported database."
  echo "Example: DATABASE_URL=postgres://user:pass@localhost/dbname"
  exit 1
fi

echo "Using DATABASE_URL: $DATABASE_URL"

# PostgreSQL driver
WITH="--with psycopg[binary]"

bold "Packages to test: $packages"

for package in $packages; do
  echo
  bold "Testing $package"

  cd "$package/tests"

  set -x
  uv run \
    --isolated \
    --package "$package" \
    $WITH \
    python -m pytest "$@"
  set +x

  cd ../..
done

# Example project (smoke-tests only)
echo
bold "Testing example"
cd "example"
uv run --isolated $WITH python -m pytest "$@"
cd ..
