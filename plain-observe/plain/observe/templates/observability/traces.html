<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Querystats</title>
    {% tailwind_css %}
</head>
<body class="text-stone-300">


    <div class="flex items-center justify-between border-b border-white/5 px-6 h-14 fixed top-0 left-0 right-0 bg-stone-950 z-10">
        <!-- <h1 class="text-lg font-semibold">Querystats</h1> -->
        <div></div>
        <div class="flex items-center space-x-2">
            {% if traces %}
            <form method="post" action=".">
                {{ csrf_input }}
                <input type="hidden" name="observe_action" value="clear">
                <button type="submit" class="px-2 py-px text-sm rounded-sm bg-stone-700 text-stone-300 hover:bg-stone-600 cursor-pointer whitespace-nowrap">Clear</button>
            </form>
            {% endif %}
            {% if observability_enabled %}
            <form method="post" action=".">
                {{ csrf_input }}
                <input type="hidden" name="observe_action" value="disable">
                <button type="submit" class="px-2 py-px text-sm rounded-sm bg-stone-700 text-stone-300 hover:bg-stone-600 cursor-pointer whitespace-nowrap">Disable</button>
            </form>
            {% else %}
            <form method="post" action=".">
                {{ csrf_input }}
                <input type="hidden" name="observe_action" value="enable">
                <button type="submit" class="px-2 py-px text-sm rounded-sm bg-stone-700 text-stone-300 hover:bg-stone-600 cursor-pointer whitespace-nowrap">Enable</button>
            </form>
            {% endif %}
        </div>
    </div>

    {% if traces %}
    <div class="flex mt-2 h-full">
        <aside id="sidebar" class="fixed left-0 top-14 bottom-0 w-82 overflow-auto p-4">
            <ul class="space-y-2">
                {% for trace in traces %}
                <li>
                    <button data-request-id="{{ trace.id }}" class="w-full text-left px-2 py-1 rounded hover:bg-stone-700 cursor-pointer">
                        {% if trace.description %}
                        <span class="text-sm">{{ trace.description }}</span>
                        {% endif %}
                        <span class="text-sm">{{ trace.trace_id }}</span>
                        <span class="font-semibold bg-white/5 rounded-sm px-1 py-0.5 text-xs"></span>
                        <div class="text-xs text-stone-400">{{ trace.start_time|strftime("%Y-%m-%d %H:%M:%S") }}</div>
                        <div class="text-xs text-stone-500">{{ trace.request_id }}</div>
                    </button>
                </li>
                {% endfor %}
            </ul>
        </aside>

        <main id="content" class="flex-1 p-6 overflow-auto ml-82 mt-14">
            {% for trace in traces %}
            <div class="request-detail" data-request-id="{{ trace.id }}" style="display: none;">


                <h2 class="text-lg font-semibold mb-4">Trace: {{ trace.trace_id }}</h2>
                <div>Duration {{ trace.duration_ms() }}ms</div>
                <div>Request id {{ trace.request_id }}</div>
                <div>Session key {{ trace.session_id }}</div>
                <div>User id {{ trace.user_id }}</div>

                <div class="mt-4 space-y-3 text-xs">
                    {% set ns = namespace(indent=0) %}
                    {% for span in trace.spans.all().order_by("start_time") %}

                    {% if not span.parent_id %}
                    {% set ns.indent = 0 %}
                    {% elif loop.changed(span.parent_id) %}
                    {% set ns.indent = ns.indent + 1 %}
                    {% endif %}

                    <div style="padding-left: {{ ns.indent * 1 }}rem;" class="border-l border-stone-700">
                        <details id="{{ trace.id }}-span-{{ loop.index }}" class="p-2 rounded bg-white/5">
                            <summary>
                                <div class="flex items-center space-x-2">
                                    <div>
                                        {{ span.start_time|strftime("%H:%M:%S") }}
                                    </div>
                                    <div class="flex-grow">{{ span.description() }}</div>
                                    <div class="ml-auto"><progress value="{{ span.duration_ms() }}" max="{{ trace.duration_ms() }}"></progress></div>
                                </div>
                            </summary>
                            <dl>
                                <dt>name</dt>
                                <dd><pre><code>{{ span.name|pprint }}</code></pre></dd>

                                <dt>kind</dt>
                                <dd><pre><code>{{ span.kind|pprint }}</code></pre></dd>

                                <dt>parent_id</dt>
                                <dd><pre><code>{{ span.parent_id|pprint }}</code></pre></dd>

                                <dt>start_time</dt>
                                <dd><pre><code>{{ span.start_time|pprint }}</code></pre></dd>

                                <dt>end_time</dt>
                                <dd><pre><code>{{ span.end_time|pprint }}</code></pre></dd>

                                <dt>status</dt>
                                <dd><pre><code>{{ span.status|pprint }}</code></pre></dd>

                                <dt>context</dt>
                                <dd><pre><code>{{ span.context|pprint }}</code></pre></dd>

                                <dt>attributes</dt>
                                <dd><pre><code>{{ span.attributes|pprint }}</code></pre></dd>

                                <dt>events</dt>
                                <dd><pre><code>{{ span.events|pprint }}</code></pre></dd>

                                <dt>links</dt>
                                <dd><pre><code>{{ span.links|pprint }}</code></pre></dd>

                                <dt>resource</dt>
                                <dd><pre><code>{{ span.resource|pprint }}</code></pre></dd>

                            </dl>
                        </details>
                    </div>
                    {% else %}
                    <div>No spans...</div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </main>
    </div>
    {% elif observability_enabled %}
    <div class="text-center text-white/30 py-8">Observing but nothing has been recorded yet.</div>
    {% else %}
    <div class="text-center py-8">
        <div class="text-white/30">Observability is disabled.</div>
        <form method="post" action=".">
            {{ csrf_input }}
            <input type="hidden" name="observe_action" value="enable">
            <button type="submit" class="mt-2 px-2 py-px text-sm rounded-sm bg-stone-700 text-stone-300 hover:bg-stone-600 cursor-pointer whitespace-nowrap">Enable</button>
        </form>
    </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('#sidebar [data-request-id]');
            const details = document.querySelectorAll('#content .request-detail');
            buttons.forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-request-id');
                    details.forEach(div => div.style.display = 'none');
                    const sel = document.querySelector('#content .request-detail[data-request-id="' + id + '"]');
                    if (sel) sel.style.display = 'block';
                    buttons.forEach(b => b.classList.remove('bg-stone-700', 'text-white'));
                    this.classList.add('bg-stone-700', 'text-white');
                });
            });
            if (buttons.length > 0) buttons[0].click();
        });
    </script>

    </body>
</html>
