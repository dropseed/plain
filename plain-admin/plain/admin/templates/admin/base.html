{% use_elements %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {%- if title|default('') -%}
            {{ title }} - {{ app_name }} Admin
        {%- else -%}
            {{ app_name }} Admin
        {%- endif -%}
    </title>
    {% tailwind_css %}
    {% htmx_js %}
    <link href="{{ asset('admin/admin.css') }}" rel="stylesheet">
    <script nonce="{{ request.csp_nonce }}">
        // Apply sidebar state immediately to prevent flash
        (function() {
            const isCollapsed = localStorage.getItem('admin-sidebar-collapsed') === 'true';
            if (isCollapsed) {
                document.documentElement.dataset.sidebarCollapsed = 'true';
            }
        })();
    </script>
    <script src="{{ asset('admin/vendor/jquery-3.7.1.min.js') }}" nonce="{{ request.csp_nonce }}"></script>
    <script src="{{ asset('admin/vendor/chart.js') }}" defer nonce="{{ request.csp_nonce }}"></script>
    <script src="{{ asset('admin/admin.js') }}" defer nonce="{{ request.csp_nonce }}"></script>
    <script src="{{ asset('admin/vendor/popper.min.js') }}" defer nonce="{{ request.csp_nonce }}"></script>
    <link href="{{ asset('admin/vendor/tippy.css') }}" rel="stylesheet">
    <script src="{{ asset('admin/vendor/tippy.umd.min.js') }}" defer nonce="{{ request.csp_nonce }}"></script>
    {% block header_scripts %}{% endblock %}
</head>
<body
    class="flex flex-col min-h-screen bg-stone-50"
    {% if is_package_installed('plaintoolbar') %}data-toolbar-installed{% endif %}
    >

    <!-- Top bar -->
    <div class="grid grid-cols-3 items-center px-4 sticky top-0 z-50 bg-stone-50/95 backdrop-blur-md h-14">
        <div class="flex items-center space-x-3">
            <button type="button" id="sidebar-toggle" class="text-black/60 hover:text-black/90 cursor-pointer">
                <admin.Icon name="list" class="w-5 h-5" />
                <span class="sr-only">Toggle menu</span>
            </button>
            <a href="{{ url('admin:index') }}" class="text-sm font-semibold text-black/90 hover:text-black/70">Admin</a>
        </div>

        <form method="GET" action="{{ url('admin:search') }}" class="flex justify-center">
            <div class="relative">
                <label for="topbar-search" class="sr-only">Search</label>
                <input
                    type="text"
                    name="query"
                    id="topbar-search"
                    class="w-64 pr-3 pl-8 text-sm bg-black/5 inset-shadow-2xs py-1 border-none"
                    placeholder="Search the admin"
                    value="{{ global_search_query|default('') }}"
                    >
                <div class="absolute inset-y-0 left-2 flex items-center pointer-events-none">
                    <admin.Icon name="search" class="w-3.5 h-3.5 text-black/50" />
                </div>
            </div>
        </form>

        <div class="flex items-center space-x-3 justify-end">
            <a href="/" class="text-xs text-black/60 hover:text-black/90">‚Üê Back to {{ app_name }}</a>
            <button type="button" data-dropdown class="flex items-center text-sm text-black/70 hover:text-black/90 cursor-pointer">
                {% set gravatar_url = get_gravatar_url(user) %}
                {% if gravatar_url %}
                    <img
                        src="{{ gravatar_url }}"
                        alt="{{ user }}"
                        class="w-5 h-5 rounded-full"
                    />
                {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-4 h-4 bi bi-person-circle" viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                    </svg>
                {% endif %}
                <template>
                    <div class="py-1">
                        <form method="POST" action="{{ url('logout') }}">
                            <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-black/70 hover:bg-stone-100 rounded">
                                Log out
                            </button>
                        </form>
                    </div>
                </template>
            </button>
        </div>
    </div>

    <div class="mb-10 flex flex-grow relative">
        <nav
            id="admin-sidebar"
            class="flex flex-col bg-stone-50 z-40 justify-between flex-shrink-0 w-52 overflow-auto sticky top-14 self-start max-h-[calc(100vh-3.5rem)] pb-20 ml-0
                   [[data-sidebar-collapsed]_&]:absolute [[data-sidebar-collapsed]_&]:left-0 [[data-sidebar-collapsed]_&]:top-0 [[data-sidebar-collapsed]_&]:bottom-0 [[data-sidebar-collapsed]_&]:-ml-52 [[data-sidebar-collapsed]_&]:z-40
                   data-[preview]:!ml-0 data-[preview]:bg-stone-50/20 data-[preview]:backdrop-blur-md"
            hx-preserve="true">
            <div class="flex-grow pl-4 pr-2 lg:pl-2 lg:pr-4">

                {% set app_sections = admin_registry.get_app_nav_sections() %}
                {% if app_sections %}
                <div>
                    <div class="mt-4 mb-2 px-2 text-xs text-black/60 uppercase tracking-wider">App</div>

                    {% for section, views in app_sections.items() %}
                    {% if section.name %}
                    <button
                        data-nav-toggle="app-section-{{ loop.index }}"
                        class="flex items-center justify-between w-full px-2 py-1 mt-1 text-sm rounded hover:bg-stone-100 cursor-pointer"
                        title="Toggle {{ section.name }}">
                        <div class="flex items-center">
                            <admin.Icon name={section.icon} class="w-3.5 h-3.5 mr-2 flex-shrink-0 text-black/70" />
                            <span class="text-black/80">{{ section.name }}</span>
                        </div>
                        <admin.Icon name="chevron-down" class="w-2 h-2 transition-transform text-black/40" data-nav-toggle-icon />
                    </button>
                    <div id="app-section-{{ loop.index }}" class="hidden">
                        {% for view in views %}
                        {% set url = view.get_view_url() %}
                        <a
                            {% if url == request.path or view in parent_view_classes %}data-active{% endif %}
                            class="data-[active]:text-blue-700 data-[active]:font-medium flex items-center px-2 py-0.5 mt-px text-sm rounded hover:text-black/90 text-black/80 hover:bg-stone-100 pl-8"
                            href="{{ url }}"
                            hx-boost="true">
                            <span class="truncate">{{ view.get_nav_title() }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="mb-4">
                        {% for view in views %}
                        {% set url = view.get_view_url() %}
                        <a
                            {% if url == request.path or view in parent_view_classes %}data-active{% endif %}
                            class="data-[active]:text-blue-700 data-[active]:font-medium flex items-center px-2 py-0.5 mt-px text-sm rounded hover:text-black/90 text-black/80 hover:bg-stone-100"
                            href="{{ url }}"
                            hx-boost="true">
                            <admin.Icon name={view.nav_icon} class="w-3.5 h-3.5 mr-3 flex-shrink-0 text-black/60" />
                            <span class="truncate">{{ view.get_nav_title() }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                {% set plain_sections = admin_registry.get_plain_nav_sections() %}
                {% if plain_sections %}
                <div class="mt-8">
                    <div class="mb-2 px-2 text-xs text-black/60 uppercase tracking-wider">Packages</div>

                    {% for section, views in plain_sections.items() %}
                    {% if section.name %}
                    <button
                        data-nav-toggle="plain-section-{{ loop.index }}"
                        class="flex items-center justify-between w-full px-2 py-1 mt-1 text-sm rounded hover:bg-stone-100 cursor-pointer"
                        title="Toggle {{ section.name }}">
                        <div class="flex items-center">
                            <admin.Icon name={section.icon} class="w-3.5 h-3.5 mr-2 flex-shrink-0 text-black/70" />
                            <span class="text-black/80">{{ section.name }}</span>
                        </div>
                        <admin.Icon name="chevron-down" class="w-2 h-2 transition-transform text-black/40" data-nav-toggle-icon />
                    </button>
                    <div id="plain-section-{{ loop.index }}" class="hidden">
                        {% for view in views %}
                        {% set url = view.get_view_url() %}
                        <a
                            {% if url == request.path or view in parent_view_classes %}data-active{% endif %}
                            class="data-[active]:text-blue-700 data-[active]:font-medium flex items-center px-2 py-0.5 mt-px text-sm rounded hover:text-black/90 text-black/80 hover:bg-stone-100 pl-8"
                            href="{{ url }}"
                            hx-boost="true">
                            <span class="truncate">{{ view.get_nav_title() }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div>
                        {% for view in views %}
                        {% set url = view.get_view_url() %}
                        <a
                            {% if url == request.path or view in parent_view_classes %}data-active{% endif %}
                            class="data-[active]:text-blue-700 data-[active]:font-medium flex items-center px-2 py-0.5 mt-px text-sm rounded hover:text-black/90 text-black/80 hover:bg-stone-100"
                            href="{{ url }}"
                            hx-boost="true">
                            <admin.Icon name={view.nav_icon} class="w-3.5 h-3.5 mr-3 flex-shrink-0 text-black/60" />
                            <span class="truncate">{{ view.get_nav_title() }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </nav>

        <div id="admin-content" class="admin-content bg-white mx-4 mt-2 mb-6 rounded-lg border border-black/5 text-black/90 flex-grow">
            <header class="flex items-center justify-between px-4 lg:px-8 inset-x-0 py-4 border-b border-black/5">
                <div class="flex-shrink-0 overflow-hidden">
                {% block header %}
                    <div class="flex items-center">
                        <div class="truncate">
                            <nav class="flex items-center text-sm sm:text-base lg:text-xl text-black/90 space-x-1" aria-label="Breadcrumb">
                                {% for parent_view in parent_view_classes|reverse %}
                                    {% if parent_view.nav_section %}
                                        <span class="text-black/50 text-sm">{{ parent_view.nav_section }}</span>
                                        <admin.Icon name="chevron-right" class="w-3 h-3 text-black/40" />
                                    {% endif %}
                                    <a href="{{ parent_view.get_view_url(object if object is defined else None) }}" class="inline-flex items-center hover:text-black/70 text-black/60 text-sm">
                                        {{ parent_view.get_nav_title() }}
                                    </a>
                                    <admin.Icon name="chevron-right" class="w-3 h-3 text-black/40" />
                                {% endfor %}
                                {% if view_class.nav_section and not parent_view_classes %}
                                    <span class="text-black/50 text-sm">{{ view_class.nav_section }}</span>
                                    <admin.Icon name="chevron-right" class="w-3 h-3 text-black/40" />
                                {% endif %}
                                {% block image %}
                                    {% if image %}
                                    <img src="{{ image.src }}" alt="{{ image.alt }}" class="h-5 rounded mr-2 flex-shrink-0">
                                    {% endif %}
                                {% endblock %}
                                <h1 class="font-semibold text-sm">{% block title %}{{ title }}{% endblock %}</h1>
                            </nav>
                        </div>
                    </div>
                {% endblock %}
                </div>
                <div class="flex items-center space-x-2 text-sm actions flex-shrink-0">
                    {# Styled with admin.css for easier adding of elements #}
                    {% block actions %}{% endblock %}
                    {% for link, url in links.items() %}
                    <a href="{{ url }}">{{ link }}</a>
                    {% endfor %}
                </div>
            </header>

            {% if cards %}
            <div class="px-4 mt-4 lg:px-8">
                <div class="grid grid-cols-1 gap-6 mt-4 sm:grid-cols-2 lg:grid-cols-4">
                    {% for card in cards %}
                        {{ render_card(card)|safe }}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <main class="px-4 pt-4 pb-6 lg:px-8 text-black/70">{% block content %}{% endblock %}</main>
        </div>

    </div>

    {% if is_package_installed('plaintoolbar') %}
        {% toolbar %}
    {% endif %}
</body>
</html>
