<!-- Reusable trace detail visualization -->
{% if trace %}
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Trace: {{ trace.description }}</h2>
        {% if show_delete_button|default(true) %}
        <button
            hx-delete="?trace_id={{ trace.id }}"
            plain-hx-action="trace"
            hx-swap="morph:innerHTML"
            hx-target="#main-content"
            class="flex items-center space-x-1 px-2 py-1 text-xs rounded-sm bg-red-600 text-white hover:bg-red-700 cursor-pointer"
            title="Delete this trace">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
            </svg>
            <span>Delete</span>
        </button>
        {% endif %}
    </div>
    <div class="text-sm text-stone-400 mb-2">
        <span class="font-semibold">Trace ID:</span> {{ trace.trace_id }}
        <span class="ml-4">{{ trace.start_time|localtime|strftime("%b %-d, %-I:%M %p") }}</span>
    </div>
    <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4 text-sm">
        <div>
            <span class="text-stone-400">Duration:</span> {{ "%.2f"|format(trace.duration_ms()) }}ms
        </div>
        <div>
            <span class="text-stone-400">Request ID:</span> {{ trace.request_id }}
        </div>
        <div>
            <span class="text-stone-400">Session:</span> {{ trace.session_id or 'None' }}
        </div>
        <div>
            <span class="text-stone-400">User:</span> {{ trace.user_id or 'Anonymous' }}
        </div>
    </div>

    <!-- Spans waterfall visualization -->
    <div class="mt-4 space-y-1 text-xs">
        {% set ns = namespace(indent=0) %}
        {% for span in trace.spans.all().order_by("start_time") %}

        {% if not span.parent_id %}
        {% set ns.indent = 0 %}
        {% elif loop.changed(span.parent_id) %}
        {% set ns.indent = ns.indent + 1 %}
        {% endif %}

        <!-- Calculate relative positioning for waterfall -->
        {% set span_start_offset = ((span.start_time - trace.start_time).total_seconds() * 1000) %}
        {% set span_duration = span.duration_ms() %}
        {% set start_percent = (span_start_offset / trace.duration_ms() * 100) if trace.duration_ms() > 0 else 0 %}
        {% set width_percent = (span_duration / trace.duration_ms() * 100) if trace.duration_ms() > 0 else 0 %}

        <div style="padding-left: {{ ns.indent * 1 }}rem;" class="border-l border-stone-700">
            <details id="{{ trace.id }}-span-{{ loop.index }}" class="rounded bg-white/5 hover:bg-white/10 transition-colors min-w-[600px]">
                <summary class="cursor-pointer p-2 list-none [&::-webkit-details-marker]:hidden">
                    <div class="flex items-center">
                        <!-- Custom arrow -->
                        <div class="w-4 h-4 mr-2 flex items-center justify-center">
                            <svg class="w-3 h-3 transform transition-transform details-open:rotate-90" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <!-- Span name and info -->
                        <div class="w-80 flex items-center space-x-2">
                            <div class="text-stone-400">
                                {{ span.start_time|localtime|strftime("%-I:%M:%S %p") }}
                            </div>
                            <div class="flex-grow">{{ span.description() }}</div>
                        </div>

                        <!-- Timeline visualization -->
                        <div class="flex-1 px-4 min-w-[300px]">
                            <div class="relative h-6 bg-stone-800/50 rounded-sm">
                                <!-- Span duration bar -->
                                <div
                                    class="absolute top-1 bottom-1 rounded-sm transition-opacity hover:opacity-80
                                           data-[kind='SERVER']:bg-blue-500
                                           data-[kind='CLIENT']:bg-emerald-500
                                           data-[kind='CONSUMER']:bg-amber-500
                                           data-[kind='PRODUCER']:bg-purple-500
                                           data-[kind='INTERNAL']:bg-gray-500
                                           bg-stone-600"
                                    data-kind="{{ span.kind }}"
                                    style="left: {{ start_percent }}%; width: {{ width_percent }}%;"
                                    title="{{ span.name }} - {{ span_duration }}ms">
                                </div>
                                <!-- Duration label -->
                                <div
                                    class="absolute inset-0 flex items-center justify-start pl-1 text-xs text-white/80 font-medium whitespace-nowrap pointer-events-none"
                                    style="left: {{ start_percent }}%; width: {{ width_percent }}%;">
                                    {{ "%.2f"|format(span_duration) }}ms
                                </div>
                            </div>
                        </div>
                    </div>
                </summary>
                <!-- Span details content -->
                <div class="p-4 pt-2 bg-stone-900/50 border-t border-stone-700">
                    <!-- Database Query Section (if present) -->
                    {% if span.sql_query %}
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-blue-300 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                            Database Query
                        </h4>
                        <div class="bg-stone-800 rounded-lg p-4 border border-stone-600">
                            <pre class="text-xs text-stone-200 font-mono whitespace-pre-wrap overflow-x-auto"><code>{{ span.get_formatted_sql() }}</code></pre>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Exception Stacktrace Section (if present) -->
                    {% if span.get_exception_stacktrace() %}
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-red-300 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                            Exception Stacktrace
                        </h4>
                        <div class="bg-red-900/20 rounded-lg p-4 border border-red-600/30">
                            <pre class="text-xs text-red-100 font-mono whitespace-pre-wrap overflow-x-auto"><code>{{ span.get_exception_stacktrace() }}</code></pre>
                        </div>
                    </div>
                    {% endif %}

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Basic Info -->
                        <div>
                            <h4 class="text-sm font-semibold text-stone-300 mb-3">Basic Information</h4>
                            <div class="space-y-2 text-xs">
                                <div class="flex">
                                    <span class="text-stone-400 w-20">Name:</span>
                                    <span class="text-stone-200">{{ span.name }}</span>
                                </div>
                                <div class="flex">
                                    <span class="text-stone-400 w-20">Kind:</span>
                                    <span class="px-2 py-0.5 rounded text-xs font-medium
                                               {% if span.kind == 'SERVER' %}bg-blue-500/20 text-blue-300
                                               {% elif span.kind == 'CLIENT' %}bg-emerald-500/20 text-emerald-300
                                               {% elif span.kind == 'CONSUMER' %}bg-amber-500/20 text-amber-300
                                               {% elif span.kind == 'PRODUCER' %}bg-purple-500/20 text-purple-300
                                               {% else %}bg-gray-500/20 text-gray-300
                                               {% endif %}">
                                        {{ span.kind }}
                                    </span>
                                </div>
                                <div class="flex">
                                    <span class="text-stone-400 w-20">Duration:</span>
                                    <span class="text-stone-200">{{ "%.2f"|format(span.duration_ms()) }}ms</span>
                                </div>
                                {% if span.parent_id %}
                                <div class="flex">
                                    <span class="text-stone-400 w-20">Parent:</span>
                                    <span class="text-stone-200 font-mono text-xs">{{ span.parent_id }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div>
                            <h4 class="text-sm font-semibold text-stone-300 mb-3">Timing</h4>
                            <div class="space-y-2 text-xs">
                                <div class="flex">
                                    <span class="text-stone-400 w-20">Started:</span>
                                    <span class="text-stone-200">{{ span.start_time|localtime|strftime("%-I:%M:%S.%f %p") }}</span>
                                </div>
                                <div class="flex">
                                    <span class="text-stone-400 w-20">Ended:</span>
                                    <span class="text-stone-200">{{ span.end_time|localtime|strftime("%-I:%M:%S.%f %p") }}</span>
                                </div>
                                {% if span.status and span.status.status_code != 'UNSET' %}
                                <div class="flex">
                                    <span class="text-stone-400 w-20">Status:</span>
                                    <span class="px-2 py-0.5 rounded text-xs font-medium
                                               {% if span.status.status_code == 'ERROR' %}bg-red-500/20 text-red-300
                                               {% elif span.status.status_code == 'OK' %}bg-green-500/20 text-green-300
                                               {% else %}bg-yellow-500/20 text-yellow-300
                                               {% endif %}">
                                        {{ span.status.status_code }}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if span.attributes %}
                    <div class="mt-6">
                        <h4 class="text-sm font-semibold text-stone-300 mb-3">Attributes</h4>
                        <div class="bg-stone-800/50 rounded p-3 max-h-48 overflow-y-auto">
                            <div class="space-y-1 text-xs">
                                {% for key, value in span.attributes.items() %}
                                <div class="flex">
                                    <span class="text-stone-400 min-w-0 flex-shrink-0 pr-2">{{ key }}:</span>
                                    <span class="text-stone-200 break-words">{{ value }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if span.events %}
                    <div class="mt-6">
                        <h4 class="text-sm font-semibold text-stone-300 mb-3">Events ({{ span.events|length }})</h4>
                        <div class="bg-stone-800/50 rounded p-3 max-h-48 overflow-y-auto">
                            <div class="space-y-3 text-xs">
                                {% for event in span.events %}
                                <div class="border-l-2 border-stone-600 pl-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <div class="text-stone-200 font-medium">{{ event.name }}</div>
                                        <div class="text-stone-400 text-xs">
                                            {% set formatted_time = span.format_event_timestamp(event.timestamp) %}
                                            {% if formatted_time.__class__.__name__ == 'datetime' %}
                                                {{ formatted_time|localtime|strftime("%-I:%M:%S.%f %p") }}
                                            {% else %}
                                                {{ formatted_time }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if event.attributes %}
                                    <div class="space-y-1">
                                        {% for key, value in event.attributes.items() %}
                                        <div class="flex">
                                            <span class="text-stone-400 min-w-0 flex-shrink-0 pr-2">{{ key }}:</span>
                                            <pre class="text-stone-200 whitespace-pre-wrap break-words font-mono text-xs">{{ value }}</pre>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if span.links %}
                    <div class="mt-6">
                        <h4 class="text-sm font-semibold text-stone-300 mb-3">Links ({{ span.links|length }})</h4>
                        <div class="bg-stone-800/50 rounded p-3">
                            <div class="space-y-2 text-xs">
                                {% for link in span.links %}
                                <div class="border-l-2 border-stone-600 pl-2">
                                    <div class="text-stone-200 font-mono">{{ link.context.trace_id }}</div>
                                    <div class="text-stone-400 font-mono">{{ link.context.span_id }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </details>
        </div>
        {% else %}
        <div>No spans...</div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center text-stone-400 py-12">
        <p class="text-lg mb-2">Select a trace from the sidebar to view details</p>
        <p class="text-sm">Click on any trace in the list to see its spans and timeline</p>
    </div>
{% endif %}

<style>
    /* Custom details arrow animation */
    details[open] summary svg {
        transform: rotate(90deg);
    }
</style>
